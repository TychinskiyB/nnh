{% extends "admin/base.html" %}


{% block admin %}
<h1 class="mt-0">{{ item and 'Редактировать' or 'Добавить' }} решение</h1>


<style>
  /* аккуратная форма */
  .form-grid{
    display:grid;gap:16px;
    grid-template-columns:1.2fr .8fr;
  }
  @media (max-width:980px){ .form-grid{ grid-template-columns:1fr } }
  .field{margin-bottom:12px}
  .field.inline{display:grid;grid-template-columns:180px 1fr;gap:12px;align-items:center}
  @media (max-width:640px){ .field.inline{grid-template-columns:1fr} }
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  .counter{font-size:12px;color:var(--muted);float:right}
  .label-row{display:flex;justify-content:space-between;align-items:center}
  .preview-card .thumb{aspect-ratio:16/9;background:#f4f4f6 center/cover no-repeat;border-radius:12px;border:1px solid var(--line)}
  .preview-card h3{margin:10px 0 4px;font-size:18px}
  .chipline{display:flex;flex-wrap:wrap;gap:6px}
  .chip{border:1px solid var(--line);background:var(--card);border-radius:999px;padding:4px 10px;font-size:12px}
  .divider{height:1px;background:var(--line);margin:10px 0}
</style>


<form method="POST" enctype="multipart/form-data" id="projectForm">
  <div class="form-grid">


    <!-- левая колонка: поля -->
    <div class="card">
      <div class="card-body">


        <div class="field">
          <div class="label-row">
            <label class="form-label">Название *</label>
            <span class="counter" id="titleCount">0 / 120</span>
          </div>
          <input class="form-input" type="text" name="title" id="f_title"
                 maxlength="120" value="{{ item.title if item else '' }}" required
                 placeholder="Например: ЦТП в блочно-модульном здании">
          <div class="hint">Коротко и по делу — заголовок карточки и модалки.</div>
        </div>


        <div class="field">
          <div class="label-row">
            <label class="form-label">Подзаголовок (на карточке)</label>
            <span class="counter" id="subCount">0 / 160</span>
          </div>
          <input class="form-input" type="text" name="subtitle" id="f_sub"
                 maxlength="160" value="{{ item.subtitle if item else '' }}"
                 placeholder="Например: 3D-модель блока / Фото на площадке">
          <div class="hint">Короткое пояснение, которое видно на карточке.</div>
        </div>


        <div class="divider"></div>








        <div class="field">
          <label class="form-label">Краткое описание</label>
          <textarea class="form-input" name="application" id="f_app" rows="3"
                    placeholder="Где используется, примеры объектов">{{ item.application if item else '' }}</textarea>
        </div>


        <div class="divider"></div>


        <div class="field">
          <label class="form-label">Обложка (URL)</label>
          <input class="form-input" type="text" name="image" id="f_image"
                 value="{{ item.image if item else '' }}"
                 placeholder="static/uploads/cover.jpg или https://…">
          <div class="hint">Если указать и URL, и файл — приоритет у файла.</div>
        </div>


        <div class="field inline">
          <label class="form-label">Или загрузить файл</label>
          <input class="form-input" type="file" name="image_file" id="f_file" accept="image/*">
        </div>


      </div>
    </div>


    <!-- правая колонка: предпросмотр карточки -->
    <div class="card preview-card">
      <div class="card-body">
        <div class="thumb" id="p_thumb"></div>
        <h3 id="p_title" class="mt-1">Заголовок проекта</h3>
        <div class="muted" id="p_sub">Подзаголовок</div>
        <div class="divider"></div>
        <div class="chipline" id="p_advchips"></div>
        <div class="hint mt-1">Предпросмотр карточки (как в «Клиентах»).</div>
      </div>
    </div>


  </div>


  <div class="mt-2">
    <button class="btn">Сохранить</button>
    <a class="btn btn-ghost" href="{{ url_for('admin_projects_list') }}">Отмена</a>
  </div>
</form>


<script>
(function(){
  const $ = (s)=>document.querySelector(s);


  // элементы формы
  const fTitle = $('#f_title');
  const fSub   = $('#f_sub');
  const fImg   = $('#f_image');
  const fFile  = $('#f_file');
  const fAdv   = $('#f_adv');


  // предпросмотр
  const pThumb = $('#p_thumb');
  const pTitle = $('#p_title');
  const pSub   = $('#p_sub');
  const pChips = $('#p_advchips');


  // счётчики
  const titleCount = $('#titleCount');
  const subCount   = $('#subCount');
  const advCount   = $('#advCount');


  function setThumb(src){
    pThumb.style.backgroundImage = src ? `url('${src}')` : '';
  }


  function updatePreview(){
    pTitle.textContent = fTitle.value.trim() || 'Заголовок проекта';
    pSub.textContent   = fSub.value.trim()   || 'Подзаголовок';
    // преимущества в чипах
    const parts = (fAdv.value || '').split(';').map(s=>s.trim()).filter(Boolean);
    advCount.textContent = parts.length;
    pChips.innerHTML = '';
    parts.slice(0,6).forEach(t=>{
      const span = document.createElement('span');
      span.className = 'chip';
      span.textContent = t;
      pChips.appendChild(span);
    });


    titleCount.textContent = (fTitle.value.length) + ' / 120';
    subCount.textContent   = (fSub.value.length) + ' / 160';
  }


  // источник изображения: file > url
  let fileURL = null;
  function updateImage(){
    const url = fImg.value.trim();
    const src = fileURL || url;
    setThumb(src);
  }


  // загрузка файла — читаем FileReader'ом
  fFile.addEventListener('change', (e)=>{
    fileURL = null;
    const file = e.target.files && e.target.files[0];
    if(!file){ updateImage(); return; }
    const reader = new FileReader();
    reader.onload = (ev)=>{ fileURL = ev.target.result; updateImage(); };
    reader.readAsDataURL(file);
  });


  [fTitle, fSub, fAdv].forEach(el=> el.addEventListener('input', updatePreview));
  fImg.addEventListener('input', updateImage);


  // первичное заполнение
  updatePreview();
  updateImage();
})();
</script>
{% endblock %}





