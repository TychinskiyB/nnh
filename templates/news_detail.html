{% extends "base.html" %}
{% block title %}{{ post.title }} — Новости — НОВОНЕФТЕХИМ{% endblock %}


{# нормализация путей: http(s), /static/… и static/… #}
{% macro norm_src(path, fallback) -%}
 {%- if not path %}{{ url_for('static', filename=fallback) }}
 {%- elif path.startswith('http://') or path.startswith('https://') %}{{ path }}
 {%- elif path.startswith('/static/') %}{{ path }}
 {%- elif path.startswith('static/') %}{{ url_for('static', filename=path[7:]) }}
 {%- else %}{{ path }}
 {%- endif -%}
{%- endmacro %}


{% block head_extra %}
<style>
 :root{
   --muted:#6e6e73;--card:#f5f5f7;--divider:rgba(0,0,0,.08);--brand:#0071e3;--ink:#1d1d1f;
 }
 @media (prefers-color-scheme:dark){
   :root{--muted:#a1a1a6;--card:#111;--divider:rgba(255,255,255,.12);--ink:#f5f5f7}
 }
 .wrap{max-width:1080px;margin:0 auto;padding:28px 20px}
 .page{display:grid;grid-template-columns:1fr;gap:40px}
 @media(min-width:1024px){.page{grid-template-columns:minmax(0,1fr) 320px;gap:56px}}
 .eyebrow{color:var(--brand);text-transform:uppercase;letter-spacing:.08em;font-size:12px;font-weight:600}
 .h1{font-size:clamp(28px,4.2vw,48px);line-height:1.08;letter-spacing:-.02em;margin:8px 0 10px}
 .meta{display:flex;gap:12px;align-items:center;color:var(--muted);font-size:14px}


 /* HERO-галерея (обложка + фото из БД) */
 .gallery{margin:16px auto 8px;max-width:980px}
 .gal-viewport{position:relative;border-radius:22px;overflow:hidden;background:var(--card);border:1px solid var(--divider);box-shadow:0 10px 26px rgba(0,0,0,.08)}
 .gal-track{display:flex;transition:transform .35s ease}
 .gal-slide{min-width:100%;aspect-ratio:16/9;display:flex;align-items:center;justify-content:center;background:#000}
 .gal-slide img{width:100%;height:100%;object-fit:contain;background:#000}
 .gal-btn{position:absolute;top:50%;transform:translateY(-50%);width:44px;height:44px;border-radius:50%;border:1px solid var(--divider);background:rgba(250,250,252,.75);backdrop-filter:blur(6px);display:grid;place-items:center;font-size:22px;cursor:pointer}
 .gal-btn:hover{background:#fff}
 .gal-btn.prev{left:10px}
 .gal-btn.next{right:10px}
 .gal-dots{display:flex;gap:6px;justify-content:center;padding:10px}
 .dot{width:8px;height:8px;border-radius:50%;background:var(--divider)}
 .dot.active{background:var(--brand)}
 .thumbs{display:flex;gap:10px;flex-wrap:nowrap;overflow:auto;padding:10px 4px;margin-top:8px}
 .thumbs img{height:64px;aspect-ratio:4/3;object-fit:cover;border-radius:10px;border:2px solid transparent;cursor:pointer;flex:0 0 auto}
 .thumbs img.active{border-color:var(--brand)}
 @media (max-width:540px){.gal-btn{display:none}}


 /* Контент */
 .content{max-width:72ch;margin:0 auto;padding:24px 0 8px;font-size:18px;line-height:1.6;color:var(--ink)}
 .content p{margin:0 0 1.2em}
 .content h2{font-size:28px;margin:1.6em 0 .6em}
 .content img{max-width:100%;height:auto;border-radius:12px}


 /* Сайдбар */
 .aside{position:sticky;top:88px;height:max-content}
 .card{background:var(--card);border:1px solid var(--divider);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.05)}
 .card .hd{padding:14px 16px;border-bottom:1px solid var(--divider);font-weight:700}
 .list{padding:10px}
 .item{display:grid;grid-template-columns:80px 1fr;gap:12px;padding:10px;border-radius:12px;text-decoration:none;color:inherit}
 .item:hover{background:color-mix(in oklab, var(--card) 60%, transparent)}
 .thumb{width:80px;height:60px;border-radius:10px;background:center/cover}
 .i-title{font-weight:600;line-height:1.25}
 .i-date{color:var(--muted);font-size:12px;margin-top:4px}
</style>
{% endblock %}


{% block content %}
<section class="section">
 <div class="wrap">
   <div class="page">


     <article>
       <header>
         <div class="eyebrow">Новости компании</div>
         <h1 class="h1">{{ post.title }}</h1>
         <div class="meta">
           <time datetime="{{ post.created_at.strftime('%Y-%m-%d') }}">{{ post.created_at.strftime('%d.%m.%Y') }}</time>
           <span id="readingTime">· 1 мин чтения</span>
         </div>
       </header>


       {# ЕДИНАЯ ГАЛЕРЕЯ: 1-й слайд — обложка, далее фото из БД #}
       {% if gallery and gallery|length > 0 %}
         <div id="dbGallery" class="gallery">
           <div class="gal-viewport">
             <button class="gal-btn prev" aria-label="Назад">‹</button>
             <div class="gal-track" id="galTrack">
               {% for img in gallery %}
                 {% set src = norm_src(img.path, "images/neftt.jpeg") %}
                 <div class="gal-slide">
                   <img src="{{ src }}" alt="Фото {{ loop.index }} новости {{ post.title }}" loading="lazy" decoding="async">
                 </div>
               {% endfor %}
             </div>
             <button class="gal-btn next" aria-label="Вперёд">›</button>
           </div>
           <div class="gal-dots" id="galDots">
             {% for _ in gallery %}<div class="dot{% if loop.first %} active{% endif %}"></div>{% endfor %}
           </div>
           <div class="thumbs" id="galThumbs">
             {% for img in gallery %}
               {% set src = norm_src(img.path, "images/neftt.jpeg") %}
               <img src="{{ src }}" alt="Миниатюра {{ loop.index }}" {% if loop.first %}class="active"{% endif %}>
             {% endfor %}
           </div>
         </div>
       {% endif %}


       <section class="content" id="articleContent">
         {{ post.body | safe }}
       </section>
     </article>


     <aside class="aside" aria-label="Последние новости">
       <div class="card">
         <div class="hd">Последние</div>
         <div class="list">
           {% set pool = recent if recent|length > 0 else posts %}
           {% set items = pool | sort(attribute='created_at', reverse=true) %}
           {% for r in items[:5] %}
             <a class="item" href="{{ url_for('news_detail', pid=r.id) }}">
               <div class="thumb" style="background-image:url('{{ norm_src(r.cover, "images/neftt.jpeg") }}');"></div>
               <div>
                 <div class="i-title">{{ r.title }}</div>
                 <div class="i-date">{{ r.created_at.strftime('%d.%m.%Y') }}</div>
               </div>
             </a>
           {% endfor %}
           {% if items|length == 0 %}
             <div style="padding:10px;color:var(--muted);">Пока нет других записей.</div>
           {% endif %}
         </div>
       </div>
     </aside>


   </div>
 </div>
</section>
{% endblock %}


{% block body_end %}
<script>
// Минуты чтения (≈220 слов/мин)
(function(){
  var el = document.getElementById('articleContent'); if(!el) return;
  var words = (el.innerText||'').trim().split(/\s+/).filter(Boolean).length;
  var min = Math.max(1, Math.round(words/220));
  var out = document.getElementById('readingTime'); if(out) out.textContent = '· ' + min + ' мин чтения';
})();


// ГАЛЕРЕЯ (cover + images)
(function(){
  const wrap = document.getElementById('dbGallery'); if(!wrap) return;
  const track = wrap.querySelector('#galTrack');
  const dots  = wrap.querySelector('#galDots');
  const thumbs= wrap.querySelector('#galThumbs');
  const slides = track.querySelectorAll('.gal-slide');
  let idx = 0;


  function update(){
    const w = track.parentElement.clientWidth;
    track.style.transform = `translateX(${-idx*w}px)`;
    dots.querySelectorAll('.dot').forEach((d,i)=>d.classList.toggle('active', i===idx));
    thumbs.querySelectorAll('img').forEach((t,i)=>t.classList.toggle('active', i===idx));
  }
  function go(n){ idx = (n + slides.length) % slides.length; update(); }


  wrap.querySelector('.prev').addEventListener('click', ()=>go(idx-1));
  wrap.querySelector('.next').addEventListener('click', ()=>go(idx+1));
  dots.addEventListener('click', e=>{
    const i=[...dots.children].indexOf(e.target); if(i>=0) go(i);
  });
  thumbs.addEventListener('click', e=>{
    const i=[...thumbs.children].indexOf(e.target); if(i>=0) go(i);
  });


  // свайпы
  (function(){
    const vp = wrap.querySelector('.gal-viewport');
    let sX=0, dx=0;
    vp.addEventListener('touchstart', e=>{ sX=e.touches[0].clientX; dx=0; }, {passive:true});
    vp.addEventListener('touchmove', e=>{ dx=e.touches[0].clientX - sX; }, {passive:true});
    vp.addEventListener('touchend', ()=>{ if(Math.abs(dx)>50){ go(idx + (dx<0?1:-1)); } });
  })();


  // клавиатура
  document.addEventListener('keydown', e=>{
    if (e.key === 'ArrowLeft')  go(idx-1);
    if (e.key === 'ArrowRight') go(idx+1);
  });


  // зум по клику
  track.addEventListener('click', e=>{
    const img = e.target.closest('img'); if(!img) return;
    img.style.objectFit = (img.style.objectFit === 'cover') ? 'contain' : 'cover';
  });


  window.addEventListener('resize', update);
  update();
})();
</script>
{% endblock %}





